<!-- by @wangyizhi571247 -->
<!-- version 0.3 -->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CF-random</title>
</head>
<body>
	<script>
		function randint(l,r) // [l,r]
		{
			return Math.floor(Math.random()*(r-l+1))+l;
		}
		var fetched=0;
		var problemset;
		function fetchProblems(callback)
		{
			if(fetched==1)
			{
				callback();
				return;
			}
			fetch('https://codeforces.com/api/problemset.problems')
				.then(response=>{
					return response.json();
				})
				.then(data=>{
					return data.result.problems;
				})
				.then(problems=>{
					// console.log(problems);
					problemset=problems;
					fetched=1;
					callback();
				});
		}
		/*
			contestId: int
			index: string
			name: string
			rating: int
			tags: array(string)
			type: string
		*/
		var randomlist=new Array();
		function newProblemLinker(problem)
		{
			const element=document.createElement("a");
			element.text=problem.contestId+problem.index+" "+problem.name+"("+problem.rating+")";

			const useluogulink=document.getElementById("use-luogu-link").checked;
			console.log(useluogulink);
			if(useluogulink) console.log("use-luogu-link on");
			var link;
			if(useluogulink) link="https://www.luogu.com.cn/problem/CF"+problem.contestId+problem.index;
			else link="https://codeforces.com/problemset/problem/"+problem.contestId+"/"+problem.index;
			console.log(link);
			element.href=link;

			element.target="_blank";
			element.rel="noopener noreferrer";
			console.log(element.href);
			return element;
		}
		function newBrElement()
		{
			const element=document.createElement("br");
			return element;
		}   
		function main()
		{
			console.log("random");

			mindifficulty=Number(document.getElementById("min-difficulty").value);
			maxdifficulty=Number(document.getElementById("max-difficulty").value);
			if(isNaN(mindifficulty)||mindifficulty==0) mindifficulty=800;
			if(isNaN(maxdifficulty)||maxdifficulty==0) maxdifficulty=3500;
			console.log(mindifficulty+'~'+maxdifficulty);

			includedtags=document.getElementById("included-tags").value.split(',');
			excludedtags=document.getElementById("excluded-tags").value.split(',');
			console.log(includedtags);
			console.log(excludedtags);

			fetchProblems(function()
			{
				var problemfilter=new Array();
				for(const problem of problemset)
				{
					var valid=1;
					if(!(problem.rating<=maxdifficulty&&problem.rating>=mindifficulty)) valid=0;

					if(!(includedtags.length==1&&includedtags[0]==""))
						for(const tag of includedtags)
					{
						var flag=0;
						for(const probtag of problem.tags)
							if(probtag.includes(tag))
							{
								flag=1;
								break;
							}
						if(!flag) valid=0;
					}

					if(!(excludedtags.length==1&&excludedtags[0]==""))
						for(const tag of excludedtags)
					{
						for(const probtag of problem.tags)
							if(probtag.includes(tag))
							{
								valid=0;
								break;
							}
					}

					if(valid) problemfilter.push(problem);
				}
				const length=problemfilter.length;
				console.log(length);
				if(length==0)
				{
					console.log("error: filter size = 0");
					return;
				}

				const randpos=randint(0,length);
				console.log(randpos);
				const problem=problemfilter[randpos];
				console.log(problem);
				randomlist.push(problem);

				const Element=document.querySelector("div.randomlist");
				console.log(Element);
				Element.insertBefore(newProblemLinker(problem),Element.lastChild.nextSibling);
				Element.insertBefore(newBrElement(),Element.lastChild.nextSibling);
			});
		}
	</script>
	<div class="filterlist" style="margin-left:50px;height:350px;width:600px;float:left;">
		<p><b>Filter</b></p>
		<input type="text" id="min-difficulty" placeholder="min-difficulty" style="margin-left:75px;">
		<a> ~ </a>
		<input type="text" id="max-difficulty" placeholder="max-difficulty">
		<br><br>
		<input type="text" id="included-tags" placeholder="included-tags (seperated by ',')" style="margin-left:45px;width:400px">
		<br><br>
		<input type="text" id="excluded-tags" placeholder="excluded-tags (seperated by ',')" style="margin-left:45px;width:400px">
		<br><br>
		<input type="checkbox" id="use-luogu-link" style="margin-left:50px;"> <a style="font-size:12px;"> use "luogu.com.cn/problem/" </a> <br>
		<br>
		<button onclick="main()" style="margin-left:200px;">
			<b>random!</b>
		</button>
		<br><br>
		<div style="font-size:12px;margin-left:100px;">
			by <a href="https://github.com/wangyizhi571247">wangyizhi571247</a>
			<a href="https://github.com/wangyizhi571247/CF-random">CF-random(github)</a>
		</div>
	</div>
	<script>
		function clearRandomlist()
		{
			randomlist=new Array();

			const Element=document.querySelector("div.randomlist");
			while(Element.lastChild.nodeName=="BR"||Element.lastChild.nodeName=="A")
			{
				Element.removeChild(Element.lastChild);
			}
		}
		function exportRandomlist()
		{
			var str=new String();
			for(pos=0;pos<randomlist.length;pos++)
			{
				const problem=randomlist[pos];
				if(pos!=0) str+=",";
				str+=problem.contestId+problem.index;
			}
			console.log(str);
			navigator.clipboard.writeText(str);
			console.log("copied");
		}
	</script>
	<div class="randomlist" style="margin-left:50px;height:1000px;width:600px;float:left;">
		<p>
			<b>Problems</b>
			<button onclick="clearRandomlist()">clear</button>
			<button onclick="exportRandomlist()">export</button>
		</p>
	</div>
</body>
</html>